<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>
Chaojie&#x27;s Home ✍️ | Vue登录及权限相关问题
</title>
    <meta name="description" content="The place where Chaojie writes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content=" Chaojie&#x27;s Home ✍️  | Vue登录及权限相关问题">
    <meta property="og:description" content="The place where Chaojie writes">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://chaojie.fun/articles/vue-deng-lu-ji-quan-xian-xiang-guan-wen-ti/">

    
    <link rel="alternate" type="application/atom+xml" title="RSS"
        href="https://chaojie.fun/atom.xml">
    
    <link rel="icon" href="https://chaojie.fun/images/favicon.ico" sizes="any">
    <link rel="stylesheet" href="https://chaojie.fun/libs/tabler.min.css">
    <link rel="stylesheet" href="https://chaojie.fun/css/uno.css">
    <link rel="stylesheet" href="https://chaojie.fun/assets/willow.css">

    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XDREGKCZH0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-XDREGKCZH0');
    </script>
    
</head>

<body>
    <div class="theme-light text-base font-sans" id="theme">
        <div class="container-xl subpixel-antialiased">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-9">
                    
<div class="col" style="margin: 24px 0;">
    <div class="row align-items-end">
        <div class="col-auto" style="margin: auto 0;">
            <a href="https://chaojie.fun/">
                <img src="https://chaojie.fun/images/logo.png" width="40" height="46" class="">
            </a>
        </div>
        <div class="col">
            <div class="row">
                <div class="col">
                    <h2 class="mb-0 tracking-wide">Chaojie&#x27;s Home ✍️</h2>
                </div>
            </div>
            <div class="row">
                <nav>
                    
<ul class="list-inline list-inline-dots mb-0">
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/">
            Home
        </a>
    </li>
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/articles/">
            Articles
        </a>
    </li>
    
    
    
    
    
    
    
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/memos/">
            Memos
        </a>
    </li>
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/tags/">
            Tags
        </a>
    </li>
    
    
    
    
    
    
    
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/about/">
            About
        </a>
    </li>
    
    
    
</ul>

                </nav>
            </div>
        </div>
        <div class="col align-self-end">
            <div class="d-flex justify-content-end space-x">
                
                
                <a href="https://chaojie.fun/atom.xml" target="_blank">
                    
                    <img src="https://chaojie.fun/images/social/douban.svg" alt=douban width="18" height="18">
                </a>
                
                <a href="https://chaojie.fun/atom.xml" target="_blank">
                    
                    <img src="https://chaojie.fun/images/social/github.svg" alt=github width="18" height="18">
                </a>
                
                <a href="https://chaojie.fun/atom.xml" target="_blank">
                    
                    <img src="https://chaojie.fun/images/social/twitter.svg" alt=twitter width="18" height="18">
                </a>
                
                
                <a href="https://chaojie.fun/atom.xml" target="_blank">
                    <img src="https://chaojie.fun/images/social/rss.svg" alt="RSS" width="18" height="18">
                </a>
            </div>
        </div>
    </div>
</div>

                    

<div class="card card-lg">
    <div class="card-body markdown text-justify">
        <div class="">
            
            
            <div class="d-flex justify-content-between" style="margin-bottom: 18px;">
                <div>2019-04-08</div>
                
                <i class="fas fa-tags"></i>
                <ul class="list-inline list-inline-dots mb-0">
                    
                    <li class="list-inline-item">
                        <a class="tag"
                            href="https://chaojie.fun/tags/qian-duan/">#前端</a>
                    </li>
                    
                    <li class="list-inline-item">
                        <a class="tag"
                            href="https://chaojie.fun/tags/vue/">#Vue</a>
                    </li>
                    

                </ul>
                
            </div>
            

            <h1>Vue登录及权限相关问题</h1>
            <p><p>最近在做一个小应用，需要用到vue实现登录，以及给不同路由设置权限。在网上看了很多文章，讲的是乱七八糟。感叹国内技术类文章实在是差劲，抄来抄去。这篇文章就说说我最后是如何实现的。</p>
<p>前后端分离项目中，后端提供api接口给前端，使用jwt发放权限。</p>
<p>首先前端提供用户名和密码请求登录接口，后端验证之后返回给前端一个token，之后前端在请求需要权限的接口时携带这个token就可以了。</p>
<h3 id="liang-ge-wen-ti">两个问题</h3>
<p>现在面临两个问题，</p>
<p>首先vue中不同的路由有不同的权限，比如我要访问后台 <strong>/admin</strong>, 就需要先登录才行，而有的页面不需要登录。</p>
<p>第二个问题是，vue组件中使用axios请求后台服务时，不同的接口有不同的权限。</p>
<p><img src="https://shiniao.fun/images/vue_auth.png" alt="Vue权限认证" /></p>
<p>先来解决第二个问题。vue不同组件都要用到axios，我们在全局为axios添加request和response的拦截器。</p>
<p>也就是，在发起请求之前，先检测header是否携带token信息。在接收响应之前，先查看后端返回状态码，如果说需要token验证就跳转到登录界面。</p>
<p>在main.js添加如下，或者新增一个http.js文件：</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#65737e;">// * http request 拦截器
</span><span style="color:#bf616a;">axios</span><span>.</span><span style="color:#bf616a;">interceptors</span><span>.</span><span style="color:#bf616a;">request</span><span>.</span><span style="color:#8fa1b3;">use</span><span>(
</span><span>    </span><span style="color:#bf616a;">config </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#65737e;">// * 判断是否存在token，如果存在的话，则每个http header都加上token
</span><span>        </span><span style="color:#65737e;">// * token会在登录之后存储在本地
</span><span>        </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">localStorage</span><span>.</span><span style="color:#bf616a;">token</span><span>) {
</span><span>            </span><span style="color:#bf616a;">config</span><span>.headers[&quot;</span><span style="color:#a3be8c;">Authorization</span><span>&quot;]  = `</span><span style="color:#a3be8c;">Bearer ${</span><span style="color:#bf616a;">localStorage</span><span style="color:#a3be8c;">.</span><span style="color:#bf616a;">token</span><span style="color:#a3be8c;">}</span><span>`;
</span><span>        }
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">config</span><span>;
</span><span>    },
</span><span>    </span><span style="color:#bf616a;">err </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Promise</span><span>.</span><span style="color:#96b5b4;">reject</span><span>(</span><span style="color:#bf616a;">err</span><span>);
</span><span>    });
</span><span>
</span><span style="color:#65737e;">// * http response 拦截器
</span><span style="color:#bf616a;">axios</span><span>.</span><span style="color:#bf616a;">interceptors</span><span>.</span><span style="color:#bf616a;">response</span><span>.</span><span style="color:#8fa1b3;">use</span><span>(
</span><span>    </span><span style="color:#bf616a;">response </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">data </span><span>= </span><span style="color:#bf616a;">response</span><span>.data;
</span><span>        </span><span style="color:#65737e;">// * 正常返回数据
</span><span>        </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">data</span><span>.code === </span><span style="color:#d08770;">0</span><span>) {
</span><span>            </span><span style="color:#65737e;">// * 返回data
</span><span>            </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">data
</span><span>        }
</span><span>        </span><span style="color:#65737e;">// * 如果code是20103 表示token未认证(后端定义的错误码)
</span><span>        </span><span style="color:#65737e;">// * 跳转到login
</span><span>        </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">data</span><span>.code === </span><span style="color:#d08770;">20103</span><span>) {
</span><span>            </span><span style="color:#bf616a;">router</span><span>.</span><span style="color:#96b5b4;">replace</span><span>(&#39;</span><span style="color:#a3be8c;">/login</span><span>&#39;)
</span><span>        }
</span><span>        </span><span style="color:#b48ead;">return  </span><span style="color:#ebcb8b;">Promise</span><span>.</span><span style="color:#96b5b4;">reject</span><span>(</span><span style="color:#bf616a;">data</span><span>);
</span><span>    },
</span><span>    </span><span style="color:#bf616a;">error </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Promise</span><span>.</span><span style="color:#96b5b4;">reject</span><span>(</span><span style="color:#bf616a;">error</span><span>);
</span><span>    });
</span><span>
</span><span style="color:#ebcb8b;">Vue</span><span>.prototype.</span><span style="color:#bf616a;">$http </span><span>= </span><span style="color:#bf616a;">axios</span><span>;
</span></code></pre>
<p>现在发起的任何请求之前都会检查是否携带token，如果没有就跳到login界面。</p>
<p>在login中，携带用户名和密码获取token之后，存放到本地。</p>
<p>login.vue:</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#bf616a;">axios</span><span>.</span><span style="color:#8fa1b3;">post</span><span>(&#39;</span><span style="color:#a3be8c;">/api/login</span><span>&#39;, {
</span><span>                    email: </span><span style="color:#bf616a;">this</span><span>.</span><span style="color:#bf616a;">email</span><span>,
</span><span>                    password: </span><span style="color:#bf616a;">this</span><span>.</span><span style="color:#bf616a;">password
</span><span>                }) .</span><span style="color:#96b5b4;">then</span><span>((</span><span style="color:#bf616a;">res</span><span>) </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>                        </span><span style="color:#65737e;">// * 存储token
</span><span>                        </span><span style="color:#bf616a;">localStorage</span><span>.</span><span style="color:#96b5b4;">setItem</span><span>(&#39;</span><span style="color:#a3be8c;">token</span><span>&#39;, </span><span style="color:#bf616a;">res</span><span>.data.</span><span style="color:#bf616a;">token</span><span>);
</span><span>                        </span><span style="color:#ebcb8b;">console</span><span>.</span><span style="color:#96b5b4;">info</span><span>(&quot;</span><span style="color:#a3be8c;">login successful</span><span>&quot;);
</span><span>                        </span><span style="color:#65737e;">// * 跳转回登录前页面
</span><span>                        </span><span style="color:#bf616a;">this</span><span>.</span><span style="color:#bf616a;">$router</span><span>.</span><span style="color:#96b5b4;">push</span><span>({path: </span><span style="color:#bf616a;">this</span><span>.</span><span style="color:#bf616a;">$route</span><span>.</span><span style="color:#bf616a;">query</span><span>.</span><span style="color:#bf616a;">redirect </span><span>|| &#39;</span><span style="color:#a3be8c;">/admin</span><span>&#39;,})
</span><span>
</span><span>                    }).</span><span style="color:#96b5b4;">catch</span><span>((</span><span style="color:#bf616a;">error</span><span>) </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>                    </span><span style="color:#ebcb8b;">console</span><span>.</span><span style="color:#96b5b4;">error</span><span>(</span><span style="color:#bf616a;">error</span><span>)
</span><span>                });
</span></code></pre>
<p>现在，访问后端接口的权限问题解决了。但是在vue中我不同的页面有不同的访问权限该如何处理？vue-router官方文档给出了例子：</p>
<p>在需要权限的路由添加meta信息，表明该路由需要登录才能访问，然后在所有路由跳转之前添加处理函数，如果没有auth，跳转到登录：</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span>path: &#39;</span><span style="color:#a3be8c;">/admin</span><span>&#39;,
</span><span>name: &#39;</span><span style="color:#a3be8c;">admin</span><span>&#39;,
</span><span>component: () </span><span style="color:#b48ead;">=&gt; </span><span>import(&#39;</span><span style="color:#a3be8c;">../views/admin/Admin.vue</span><span>&#39;),
</span><span style="color:#65737e;">// * 需要登录才能访问
</span><span>meta: {requiresAuth: </span><span style="color:#d08770;">true</span><span>},
</span></code></pre>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#65737e;">// * 全局钩子
</span><span style="color:#bf616a;">router</span><span>.</span><span style="color:#8fa1b3;">beforeEach</span><span>((</span><span style="color:#bf616a;">to</span><span>, </span><span style="color:#bf616a;">from</span><span>, </span><span style="color:#bf616a;">next</span><span>) </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">to</span><span>.</span><span style="color:#bf616a;">matched</span><span>.</span><span style="color:#8fa1b3;">some</span><span>(</span><span style="color:#bf616a;">record </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">record</span><span>.</span><span style="color:#bf616a;">meta</span><span>.</span><span style="color:#bf616a;">requiresAuth</span><span>)) {
</span><span>        </span><span style="color:#65737e;">// * 对于需要auth的路径
</span><span>        </span><span style="color:#65737e;">// * 没有token信息，redirect to login
</span><span>        </span><span style="color:#b48ead;">if </span><span>(!</span><span style="color:#bf616a;">localStorage</span><span>.</span><span style="color:#bf616a;">token</span><span>) {
</span><span>            </span><span style="color:#8fa1b3;">next</span><span>({
</span><span>                path: &#39;</span><span style="color:#a3be8c;">/login</span><span>&#39;,
</span><span>                query: {redirect: </span><span style="color:#bf616a;">to</span><span>.</span><span style="color:#bf616a;">fullPath</span><span>}
</span><span>            })
</span><span>        } </span><span style="color:#b48ead;">else </span><span>{
</span><span>            </span><span style="color:#8fa1b3;">next</span><span>()
</span><span>        }
</span><span>    } </span><span style="color:#b48ead;">else </span><span>{
</span><span>        </span><span style="color:#8fa1b3;">next</span><span>() </span><span style="color:#65737e;">// 确保一定要调用 next()
</span><span>    }
</span><span>})
</span></code></pre>
<p>登出的话，清除token信息即可。</p>
<pre data-lang="javascript" style="background-color:#2b303b;color:#c0c5ce;" class="language-javascript "><code class="language-javascript" data-lang="javascript"><span style="color:#bf616a;">localStorage</span><span>.</span><span style="color:#96b5b4;">removeItem</span><span>(&quot;</span><span style="color:#a3be8c;">token</span><span>&quot;)
</span></code></pre>
<p>以上，希望有帮助。</p>
</p>

            
            
            <script src="https://giscus.app/client.js" data-repo="ischaojie/blog"
                data-repo-id="MDEwOlJlcG9zaXRvcnkyODk4MDA1NTY="
                data-category="[object]"
                data-category-id="[object]"
                data-mapping="[object]" data-strict="0" data-reactions-enabled="1"
                data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme"
                data-lang="en" data-loading="lazy" crossorigin="anonymous" async>
                </script>
            
            
        </div>
    </div>
</div>


                    
<footer class="footer footer-transparent d-print-none">
    <div class="container-xl">
        <div class="row text-center align-items-center flex-row-reverse">
            <div class="col-lg-auto ms-lg-auto">
                
<ul class="list-inline list-inline-dots mb-0">
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/">
            Home
        </a>
    </li>
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/articles/">
            Articles
        </a>
    </li>
    
    
    
    
    
    
    
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/memos/">
            Memos
        </a>
    </li>
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/tags/">
            Tags
        </a>
    </li>
    
    
    
    
    
    
    
    
    
    
    <li class="list-inline-item">
        <a class="link-secondary" href="https://chaojie.fun/about/">
            About
        </a>
    </li>
    
    
    
</ul>

            </div>
            <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0">
                    <li class="list-inline-item">
                        Copyright © 2023
                        <a href="." class="link-secondary">Chaojie</a>.
                        All rights reserved.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>

                </div>
            </div>
        </div>
    </div>
    <script src="https://chaojie.fun/libs/tabler.min.js"></script>
    <script src="https://chaojie.fun/libs/fslightbox.js"></script>
    <script src="https://chaojie.fun/libs/infinite-scroll.min.js"></script>
    <script src="https://chaojie.fun/libs/luxon.min.js"></script>
    <script src="https://chaojie.fun/js/willow.js"></script>
    


</body>

</html>
