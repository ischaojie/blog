<!DOCTYPE html>
<html lang="zh-CN" >
<head>
    <meta name="google-site-verification" content="TjxoSrOSvzF5sflWfkro3NiONSjLWtPoCVrQGbPRq2Y" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="shiniao" />
	
	
	
	<title>Vue登录及权限相关问题 ｜ -O-</title>
	
    
    
    <meta name="description" content="最近在做一个小应用，需要用到vue实现登录，以及给不同路由设置权限。在网上看了很多文章，讲的是乱七八糟。感叹国内技术类文章实在是差劲，抄来抄去。这篇文章就说说我最后是如何实现的。 前后端分离项目中，后端" />
    

    
    
    <meta name="keywords" content="鸟石, shiniao, 技术, 分布式, 数据库, 博客, 潮戒, 算法" />
    

	
    
    <link rel="shortcut icon" href="https://shiniao.fun/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://shiniao.fun/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://shiniao.fun/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://shiniao.fun/css/bootstrap-toc.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://shiniao.fun/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://shiniao.fun/css/highlight.css" />

    
    
    <link rel="stylesheet" href="https://shiniao.fun/css/o.css" />
    
</head>

<body data-spy="scroll" data-target="#toc">

    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/work/">Work</a>
            </li>
            
            <li>
                <a href="/about/">Me</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://shiniao.fun/">
                    <span>-O-</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">鸟石写字的地方</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/shiniao/" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://twitter.com/chaojie_cn/" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/zhuzhezhe" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://shiniao.fun/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/vue%E7%99%BB%E5%BD%95%E5%8F%8A%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/'>Vue登录及权限相关问题</a></h2>
                        <span class="date">2019.04.08</span>
                    </div>
                    <div class="post_content markdown"><p>最近在做一个小应用，需要用到vue实现登录，以及给不同路由设置权限。在网上看了很多文章，讲的是乱七八糟。感叹国内技术类文章实在是差劲，抄来抄去。这篇文章就说说我最后是如何实现的。</p>
<p>前后端分离项目中，后端提供api接口给前端，使用jwt发放权限。</p>
<p>首先前端提供用户名和密码请求登录接口，后端验证之后返回给前端一个token，之后前端在请求需要权限的接口时携带这个token就可以了。</p>
<h3 id="两个问题">两个问题</h3>
<p>现在面临两个问题，</p>
<p>首先vue中不同的路由有不同的权限，比如我要访问后台 <strong>/admin</strong>, 就需要先登录才行，而有的页面不需要登录。</p>
<p>第二个问题是，vue组件中使用axios请求后台服务时，不同的接口有不同的权限。</p>
<p><img src="https://shiniao.fun/images/vue_auth.png" alt="Vue权限认证"></p>
<p>先来解决第二个问题。vue不同组件都要用到axios，我们在全局为axios添加request和response的拦截器。</p>
<p>也就是，在发起请求之前，先检测header是否携带token信息。在接收响应之前，先查看后端返回状态码，如果说需要token验证就跳转到登录界面。</p>
<p>在main.js添加如下，或者新增一个http.js文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// * http request 拦截器
</span><span class="c1"></span><span class="nx">axios</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
    <span class="nx">config</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// * 判断是否存在token，如果存在的话，则每个http header都加上token
</span><span class="c1"></span>        <span class="c1">// * token会在登录之后存储在本地
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&#34;Authorization&#34;</span><span class="p">]</span>  <span class="o">=</span> <span class="sb">`Bearer </span><span class="si">${</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">config</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>

<span class="c1">// * http response 拦截器
</span><span class="c1"></span><span class="nx">axios</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
    <span class="nx">response</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="c1">// * 正常返回数据
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// * 返回data
</span><span class="c1"></span>            <span class="k">return</span> <span class="nx">data</span>
        <span class="p">}</span>
        <span class="c1">// * 如果code是20103 表示token未认证(后端定义的错误码)
</span><span class="c1"></span>        <span class="c1">// * 跳转到login
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">20103</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">router</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span>  <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">error</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">});</span>

<span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$http</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">;</span>
</code></pre></div><p>现在发起的任何请求之前都会检查是否携带token，如果没有就跳到login界面。</p>
<p>在login中，携带用户名和密码获取token之后，存放到本地。</p>
<p>login.vue:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">email</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
                    <span class="nx">password</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span>
                <span class="p">})</span> <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="c1">// * 存储token
</span><span class="c1"></span>                        <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">&#34;login successful&#34;</span><span class="p">);</span>
                        <span class="c1">// * 跳转回登录前页面
</span><span class="c1"></span>                        <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">path</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">$route</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">redirect</span> <span class="o">||</span> <span class="s1">&#39;/admin&#39;</span><span class="p">,})</span>

                    <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
                <span class="p">});</span>
</code></pre></div><p>现在，访问后端接口的权限问题解决了。但是在vue中我不同的页面有不同的访问权限该如何处理？vue-router官方文档给出了例子：</p>
<p>在需要权限的路由添加meta信息，表明该路由需要登录才能访问，然后在所有路由跳转之前添加处理函数，如果没有auth，跳转到登录：</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/admin&#39;</span><span class="p">,</span>
<span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span>
<span class="nx">component</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;../views/admin/Admin.vue&#39;</span><span class="p">),</span>
<span class="c1">// * 需要登录才能访问
</span><span class="c1"></span><span class="nx">meta</span><span class="o">:</span> <span class="p">{</span><span class="nx">requiresAuth</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// * 全局钩子
</span><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nx">beforeEach</span><span class="p">((</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">record</span> <span class="p">=&gt;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">requiresAuth</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// * 对于需要auth的路径
</span><span class="c1"></span>        <span class="c1">// * 没有token信息，redirect to login
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">({</span>
                <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/login&#39;</span><span class="p">,</span>
                <span class="nx">query</span><span class="o">:</span> <span class="p">{</span><span class="nx">redirect</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">}</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">()</span> <span class="c1">// 确保一定要调用 next()
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div><p>登出的话，清除token信息即可。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&#34;token&#34;</span><span class="p">)</span>
</code></pre></div><p>以上，希望有帮助。</p>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://shiniao.fun/tags/%E5%89%8D%E7%AB%AF/">前端</a>
                                    
                                    <a href="https://shiniao.fun/tags/vue/">Vue</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                
<div class="doc_comments">
    <div class="comments_block_title">发表评论</div>
    <div id="vcomments"></div>
</div>

<link rel="stylesheet" href="https://shiniao.fun/css/comments.css" />
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>

<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        appId: 'tGdQAqUxUGU5WwecI1lrPp3o-gzGzoHsz',
        appKey: 'SdbHV6Dzu1a7VkerYUpU4tuT',
        placeholder: ' ',
        visitor: 'true',
        avatar: 'retro',
    })
</script>
                
            </div>
        </div>
    </div>    

    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://shiniao.fun">Designed by JieChao,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div class="footer_slogan">
        <span>请你相信：无论如何，生活是合理的。——里尔克</span>
    </div>
</footer>
    <script src="https://shiniao.fun/js/jquery-3.5.1.min.js"></script>
<script src="https://shiniao.fun/js/bootstrap.min.js"></script>
<script src="https://shiniao.fun/js/bootstrap-toc.min.js"></script>
<link href="https://shiniao.fun/css/fancybox.min.css" rel="stylesheet">
<script src="https://shiniao.fun/js/fancybox.min.js"></script>
<script src="https://shiniao.fun/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



</body>

</html>